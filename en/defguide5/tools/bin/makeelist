#!/usr/bin/perl -- # -*- Perl -*-

use strict;
use English;

my $class = shift @ARGV || undef;
my @files = ();

opendir (DIR, "elements");
while (my $name = readdir(DIR)) {
    next if ! -f "elements/$name";
    next if $name !~ /\.fmt$/;

    open (F, "elements/$name");
    read (F, $_, -s "elements/$name");
    close (F);

    my @classes = /<refmiscinfo role=.class.>.*?<\/refmiscinfo>/g;
    my $match = (!@classes && !defined($class)) ? 1 : 0;
    foreach my $info (@classes) {
        $match = 1 if $info =~ />$class</;
    }

    push (@files, $name) if $match;
}
closedir (DIR);

if ($class eq 'assembly') {
    print "<reference xml:id='ref-assembly'\n";
    print "           xmlns='http://docbook.org/ns/docbook'\n";
    print "           xmlns:xi='http://www.w3.org/2001/XInclude'>\n";
    print "<title>DocBook Assembly Element Reference</title>\n";
    print "<?dbhtml filename='ref-assembly.html'?>\n\n";

    print "<xi:include href='intro-assembly.xml'/>\n\n";
} elsif (!defined($class)) {
    print "<reference xml:id='ref-element'\n";
    print "           xmlns='http://docbook.org/ns/docbook'\n";
    print "           xmlns:xi='http://www.w3.org/2001/XInclude'>\n";

    print "<title>DocBook Element Reference</title>\n";
    print "<?dbhtml filename='ref-elements.html'?>\n\n";

    print "<xi:include href='intro-elements.xml'/>\n\n";
} else {
    print STDERR "Unexpected class: $class\n";
    exit 1;
}

my @any = ();
foreach my $file (sort specialsort @files) {
    my $name = $file;
    $name =~ s/^.*\/([^\/]+)$/$1/;

    if ($file =~ /_any/) {
	push (@any, "<xi:include href='elements/$name'/>");
    } else {
	print "<xi:include href='elements/$name'/>\n";
    }
}

foreach my $line (@any) {
    print "$line\n";
}

print "\n</reference>\n";

sub specialsort {
    # Make sure _x sorts after x
    my $ap = $a;
    my $bp = $b;

    $ap =~ s/^_//;
    $bp =~ s/^_//;

    if ($ap eq $bp) {
        return $b cmp $a;
    } else {
        return $ap cmp $bp;
    }
}
